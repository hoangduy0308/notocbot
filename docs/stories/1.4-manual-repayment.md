# Story 1.4: Manual Repayment Recording (L·ªánh /paid)

**Tr·∫°ng th√°i:** Approved üü¢

## 1. User Story
* **L√†:** Ng∆∞·ªùi d√πng
* **T√¥i mu·ªën:** Ghi nh·∫≠n khi ai ƒë√≥ tr·∫£ ti·ªÅn cho m√¨nh b·∫±ng l·ªánh r√µ r√†ng (v√≠ d·ª•: `/paid @Tuan 20000`).
* **ƒê·ªÉ:** C·∫≠p nh·∫≠t s·ªë d∆∞ n·ª£ m√† kh√¥ng x√≥a m·∫•t l·ªãch s·ª≠ giao d·ªãch c≈©.

## 2. Acceptance Criteria (Ti√™u ch√≠ ch·∫•p nh·∫≠n)
1. Bot nh·∫≠n di·ªán l·ªánh `/paid` (ho·∫∑c `/tra`) v·ªõi tham s·ªë: `[T√™n] [S·ªë ti·ªÅn] [Ghi ch√∫ t√πy ch·ªçn]`.
2. **Logic Transaction:**
    * T√¨m Debtor t∆∞∆°ng ·ª©ng (t√°i s·ª≠ d·ª•ng logic c·ªßa Story 1.3).
    * L∆∞u m·ªôt d√≤ng m·ªõi v√†o b·∫£ng `transactions`.
    * Quan tr·ªçng: `amount` v·∫´n l√† s·ªë d∆∞∆°ng (v√≠ d·ª• 20000), nh∆∞ng `type` ph·∫£i l√† `'CREDIT'`.
3. **Ph·∫£n h·ªìi:** Bot tr·∫£ l·ªùi x√°c nh·∫≠n: *"ƒê√£ ghi nh·∫≠n [T√™n] tr·∫£: [S·ªë ti·ªÅn]"*.
4. **Hi·ªÉn th·ªã s·ªë d∆∞:** Sau khi ghi, Bot t√≠nh to√°n v√† hi·ªÉn th·ªã ngay s·ªë d∆∞ c√≤n l·∫°i (v√≠ d·ª•: "D∆∞ n·ª£ c√≤n l·∫°i: 30,000ƒë").

## 3. Tasks (Nhi·ªám v·ª• c·ª• th·ªÉ)
* [x] C·∫≠p nh·∫≠t `src/services/debt_service.py`:
    * T·∫≠n d·ª•ng h√†m `add_transaction` ƒë√£ vi·∫øt ·ªü Story 1.3 (th√™m tham s·ªë `transaction_type` m·∫∑c ƒë·ªãnh l√† 'DEBT', Story n√†y truy·ªÅn v√†o 'CREDIT').
    * Vi·∫øt th√™m h√†m `get_debtor_balance(debtor_id)`: Th·ª±c hi·ªán query SQL `SUM(DEBT) - SUM(CREDIT)` ƒë·ªÉ t√≠nh s·ªë d∆∞ hi·ªán t·∫°i.
* [x] C·∫≠p nh·∫≠t `src/bot/handlers.py`:
    * Th√™m h√†m `paid_command`.
    * Parse arguments.
    * G·ªçi `debt_service.add_transaction`.
    * G·ªçi `debt_service.get_debtor_balance` ƒë·ªÉ l·∫•y s·ªë d∆∞ m·ªõi nh·∫•t.
    * Format tin nh·∫Øn tr·∫£ v·ªÅ ƒë·∫πp m·∫Øt.
* [x] ƒêƒÉng k√Ω `paid_handler` (cho c·∫£ l·ªánh `/paid` v√† `/tra`) trong `src/main.py`.

## 4. Dev Notes
* **DRY (Don't Repeat Yourself):** Logic t√¨m User v√† Debtor y h·ªát Story 1.3. H√£y ƒë·∫£m b·∫£o code t√°i s·ª≠ d·ª•ng ƒë∆∞·ª£c, kh√¥ng copy-paste b·ª´a b√£i.
* **SQL Balance Logic:** `SELECT COALESCE(SUM(CASE WHEN type='DEBT' THEN amount ELSE 0 END), 0) - COALESCE(SUM(CASE WHEN type='CREDIT' THEN amount ELSE 0 END), 0)`.