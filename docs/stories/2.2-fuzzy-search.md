# Story 2.2: Smart Contact Matching (Fuzzy Search)

**Tr·∫°ng th√°i:** Approved üü¢

## 1. User Story
* **L√†:** Ng∆∞·ªùi d√πng
* **T√¥i mu·ªën:** Bot h·ªèi l·∫°i t√¥i khi t√¥i nh·∫≠p m·ªôt c√°i t√™n m∆° h·ªì ho·∫∑c g·∫ßn gi·ªëng v·ªõi nh·ªØng ng∆∞·ªùi ƒë√£ c√≥ trong danh b·∫°.
* **ƒê·ªÉ:** T√¥i kh√¥ng b·ªã ghi nh·∫ßm n·ª£ cho ng∆∞·ªùi kh√°c ho·∫∑c t·∫°o ra nhi·ªÅu h·ªì s∆° tr√πng l·∫∑p (v√≠ d·ª•: "Tuan" v√† "Tu·∫•n").

## 2. Acceptance Criteria (Ti√™u ch√≠ ch·∫•p nh·∫≠n)
1. **∆Øu ti√™n kh·ªõp ch√≠nh x√°c:** N·∫øu nh·∫≠p "Tu·∫•n" v√† c√≥ debtor "Tu·∫•n" -> Ghi lu√¥n (kh√¥ng h·ªèi).
2. **Ph√°t hi·ªán g·∫ßn ƒë√∫ng (Fuzzy):** N·∫øu nh·∫≠p "Duy" m√† ch∆∞a c√≥ "Duy", nh∆∞ng c√≥ "Kh√°nh Duy" (ƒë·ªô tr√πng kh·ªõp > 60%) -> Bot d·ª´ng l·∫°i v√† h·ªèi.
3. **Giao di·ªán h·ªèi (UX):** Bot hi·ªán danh s√°ch c√°c t√™n g·∫ßn gi·ªëng d∆∞·ªõi d·∫°ng n√∫t b·∫•m (Inline Buttons):
    * [1. Kh√°nh Duy]
    * [2. Ho√†ng Duy]
    * [3. T·∫°o m·ªõi "Duy"]
4. **X·ª≠ l√Ω ch·ªçn:** Khi ng∆∞·ªùi d√πng b·∫•m n√∫t, Bot th·ª±c hi·ªán l·ªánh ghi n·ª£/tr·∫£ n·ª£ cho c√°i t√™n ƒë√£ ch·ªçn ƒë√≥.
5. **State Management:** Bot ph·∫£i nh·ªõ ƒë∆∞·ª£c th√¥ng tin giao d·ªãch (s·ªë ti·ªÅn, ghi ch√∫) trong l√∫c ch·ªù ng∆∞·ªùi d√πng b·∫•m n√∫t.

## 3. Tasks (Nhi·ªám v·ª• c·ª• th·ªÉ)
* [x] C·∫≠p nh·∫≠t `requirements.txt`: Th√™m th∆∞ vi·ªán `thefuzz` v√† `python-levenshtein`.
* [x] C·∫≠p nh·∫≠t `src/services/debtor_service.py`:
    * Th√™m h√†m `search_debtors_fuzzy(user_id, name_query)`: Tr·∫£ v·ªÅ list c√°c ·ª©ng vi√™n (candidates) c√≥ `fuzz.ratio` > 60.
* [x] C·∫≠p nh·∫≠t `src/bot/handlers.py`:
    * S·ª≠a logic x·ª≠ l√Ω tin nh·∫Øn (NLP): Thay v√¨ g·ªçi `get_or_create_debtor` ngay, h√£y g·ªçi `search_debtors_fuzzy` tr∆∞·ªõc.
    * N·∫øu t√¨m th·∫•y 1 k·∫øt qu·∫£ ch√≠nh x√°c (100%) ho·∫∑c kh√¥ng c√≥ k·∫øt qu·∫£ n√†o g·∫ßn gi·ªëng -> X·ª≠ l√Ω nh∆∞ c≈©.
    * N·∫øu c√≥ nhi·ªÅu k·∫øt qu·∫£ g·∫ßn gi·ªëng -> G·ª≠i tin nh·∫Øn k√®m `InlineKeyboardMarkup`. L∆∞u th√¥ng tin giao d·ªãch t·∫°m v√†o `context.user_data['pending_transaction']`.
    * Vi·∫øt h√†m `button_callback_handler(update, context)` ƒë·ªÉ x·ª≠ l√Ω s·ª± ki·ªán b·∫•m n√∫t: L·∫•y th√¥ng tin t·ª´ `user_data`, th·ª±c hi·ªán ghi n·ª£ v·ªõi ID ƒë√£ ch·ªçn, v√† x√≥a tin nh·∫Øn h·ªèi.
* [x] ƒêƒÉng k√Ω `CallbackQueryHandler` trong `src/main.py`.

## 4. Dev Notes
* **Libraries:** S·ª≠ d·ª•ng `thefuzz` l√† chu·∫©n nh·∫•t hi·ªán nay.
* **User Data:** `context.user_data` c·ªßa PTB l√† n∆°i l√Ω t∆∞·ªüng ƒë·ªÉ l∆∞u tr·∫°ng th√°i t·∫°m th·ªùi (session) gi·ªØa c√°c b∆∞·ªõc chat.