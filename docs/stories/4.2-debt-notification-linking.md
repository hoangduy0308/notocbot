# Story 4.2: Cross-User Notification & Linking (DM to DM)

**Status:** Approved
**Epic:** Group Debt & Mutual Notifications
**Priority:** High
**Estimates:** 4 hours

## 1. User Story
**As a** User (Chá»§ ná»£),
**I want to** liÃªn káº¿t há»“ sÆ¡ "con ná»£" (Debtor) trong danh báº¡ áº£o cá»§a tÃ´i vá»›i tÃ i khoáº£n Telegram thá»±c cá»§a há»,
**So that** khi tÃ´i ghi ná»£, Bot sáº½ tá»± Ä‘á»™ng gá»­i tin nháº¯n thÃ´ng bÃ¡o sang há»™p thÆ° riÃªng cá»§a há» (DM) Ä‘á»ƒ há» biáº¿t mÃ  khÃ´ng cáº§n táº¡o nhÃ³m chung.

## 2. Constraints (Luáº­t Telegram)
* **Báº¯t buá»™c:** NgÆ°á»i Ä‘Æ°á»£c nháº­n thÃ´ng bÃ¡o (Con ná»£) pháº£i Ä‘Ã£ tá»«ng báº¥m `/start` vá»›i Bot (Ä‘á»ƒ Bot cÃ³ quyá»n nháº¯n tin cho há»).
* **Privacy:** Bot khÃ´ng thá»ƒ tá»± Ä‘oÃ¡n ID tá»« username náº¿u ngÆ°á»i Ä‘Ã³ chÆ°a cÃ³ trong Database há»‡ thá»‘ng (`users` table).

## 3. Acceptance Criteria
* **AC1 (Lá»‡nh Link):**
    * CÃº phÃ¡p: `/link [TÃªnDebtor] [@Username]` (VÃ­ dá»¥: `/link Duy @khanhduy`).
    * Há»‡ thá»‘ng tÃ¬m trong báº£ng `users` xem cÃ³ ai lÃ  `@khanhduy` khÃ´ng.
    * **Náº¿u cÃ³:** Update `telegram_id` cá»§a `@khanhduy` vÃ o báº£ng `debtors` (báº£n ghi cÃ³ tÃªn "Duy" cá»§a User Ä‘ang chat). BÃ¡o thÃ nh cÃ´ng.
    * **Náº¿u khÃ´ng:** BÃ¡o lá»—i "NgÆ°á»i dÃ¹ng @khanhduy chÆ°a sá»­ dá»¥ng Bot. HÃ£y báº£o há» chat /start vá»›i Bot trÆ°á»›c".
* **AC2 (CÆ¡ cháº¿ ThÃ´ng bÃ¡o):**
    * Khi User A ghi ná»£ thÃ nh cÃ´ng (vd: "Duy ná»£ 50k"), há»‡ thá»‘ng kiá»ƒm tra `debtor` "Duy".
    * Náº¿u `debtor.telegram_id` tá»“n táº¡i (Ä‘Ã£ link): Bot gá»­i tin nháº¯n Ä‘áº¿n ID Ä‘Ã³:
        > *"ğŸ”” **[TÃªn User A]** vá»«a ghi ná»£ cho báº¡n: 50,000Ä‘. LÃ½ do: Äƒn trÆ°a"*
    * Náº¿u chÆ°a link: Ghi ná»£ bÃ¬nh thÆ°á»ng, khÃ´ng bÃ¡o lá»—i, nhÆ°ng khÃ´ng gá»­i thÃ´ng bÃ¡o.

## 4. Tasks
- [ ] **Task 1: User Lookup Service**
    - File: `src/services/user_service.py`
    - Logic: Äáº£m báº£o khi user `/start`, lÆ°u cáº£ `username` vÃ o báº£ng `users`.
    - Viáº¿t hÃ m `get_user_by_username(username_string)`.
- [ ] **Task 2: Link Command Handler**
    - File: `src/bot/handlers.py`
    - Logic: Xá»­ lÃ½ lá»‡nh `/link`. Gá»i `debtor_service` Ä‘á»ƒ update cá»™t `telegram_id` cho debtor.
- [ ] **Task 3: Notification Hook**
    - File: `src/services/debt_service.py` (sau khi save transaction) hoáº·c `src/bot/handlers.py`.
    - Logic: Náº¿u `debtor.telegram_id` is not None -> `context.bot.send_message(...)`.

## 5. Dev Notes
* **User Model:** Kiá»ƒm tra láº¡i `src/database/models.py`. Náº¿u báº£ng `User` chÆ°a cÃ³ cá»™t `username`, cáº§n táº¡o migration thÃªm vÃ o (Ä‘á»ƒ phá»¥c vá»¥ viá»‡c tÃ¬m kiáº¿m theo @username).
* **Security:** Khi gá»­i tin nháº¯n sang ngÆ°á»i B, cáº§n format text rÃµ rÃ ng Ä‘á»ƒ há» biáº¿t ai Ä‘ang Ä‘Ã²i ná»£.