# Story 3.1: Calculate Net Balance & Summary (Tra c·ª©u S·ªë d∆∞ & T·ªïng quan)

**Tr·∫°ng th√°i:** Approved üü¢

## 1. User Story
* **L√†:** Ng∆∞·ªùi d√πng
* **T√¥i mu·ªën:** Ki·ªÉm tra s·ªë d∆∞ n·ª£ c·ªßa m·ªôt ng∆∞·ªùi c·ª• th·ªÉ HO·∫∂C xem t·ªïng k·∫øt to√†n b·ªô danh s√°ch n·ª£.
* **ƒê·ªÉ:** Bi·∫øt con s·ªë t·ªïng ƒë·ªÉ nh·∫Øc n·ª£ ho·∫∑c ƒë·ªëi chi·∫øu t√†i ch√≠nh c√° nh√¢n.

## 2. Acceptance Criteria (Ti√™u ch√≠ ch·∫•p nh·∫≠n)
1. **Tra c·ª©u c√° nh√¢n:**
    * L·ªánh: `/balance [T√™n]` (ho·∫∑c h·ªèi NLP: "Duy n·ª£ bao nhi√™u", "Xem n·ª£ Duy").
    * Logic: √Åp d·ª•ng Fuzzy Search/Alias ƒë·ªÉ t√¨m ƒë√∫ng ng∆∞·ªùi -> Tr·∫£ v·ªÅ s·ªë d∆∞.
    * Ph·∫£n h·ªìi: *"üí∞ T·ªïng d∆∞ n·ª£ c·ªßa [T√™n]: [S·ªë ti·ªÅn]"* ho·∫∑c *"‚úÖ [T√™n] kh√¥ng c√≤n kho·∫£n n·ª£ n√†o (0ƒë)"*.
2. **Tra c·ª©u t·ªïng quan (M·ªõi):**
    * L·ªánh: `/summary` (ho·∫∑c `/balance` kh√¥ng tham s·ªë, ho·∫∑c NLP: "T·ªïng n·ª£", "Ai ƒëang n·ª£ t√¥i").
    * Logic: Li·ªát k√™ t·∫•t c·∫£ nh·ªØng ng∆∞·ªùi c√≥ s·ªë d∆∞ KH√ÅC 0.
    * Format hi·ªÉn th·ªã danh s√°ch r√µ r√†ng, c√≥ d√≤ng t·ªïng c·ªông cu·ªëi c√πng.
3. **Giao di·ªán:** S·ª≠ d·ª•ng emoji (üü¢ n·ª£ d∆∞∆°ng, üî¥ tr·∫£ th·ª´a/√¢m) ƒë·ªÉ d·ªÖ nh√¨n.

## 3. Tasks (Nhi·ªám v·ª• c·ª• th·ªÉ)
* [ ] C·∫≠p nh·∫≠t `src/bot/nlp_engine.py`: Th√™m Regex b·∫Øt c√¢u h·ªèi xem n·ª£ (keywords: "bao nhi√™u", "d∆∞ n·ª£", "xem n·ª£") v√† t·ªïng n·ª£ ("t·ªïng n·ª£", "summary", "ai n·ª£").
* [ ] C·∫≠p nh·∫≠t `src/services/debt_service.py`:
    * Th√™m h√†m `get_all_debtors_balance(user_id)`: Query to√†n b·ªô debtor v√† t√≠nh balance. Filter b·ªè nh·ªØng ng∆∞·ªùi balance = 0.
* [ ] C·∫≠p nh·∫≠t `src/bot/handlers.py`:
    * S·ª≠a `get_balance_command`:
        * N·∫øu c√≥ tham s·ªë t√™n -> G·ªçi logic c√° nh√¢n (t√°i s·ª≠ d·ª•ng search fuzzy).
        * N·∫øu kh√¥ng c√≥ tham s·ªë -> G·ªçi logic Summary.
    * Format tin nh·∫Øn tr·∫£ v·ªÅ ƒë·∫πp m·∫Øt (d√πng Markdown ho·∫∑c HTML mode c·ªßa Telegram).
* [ ] ƒêƒÉng k√Ω l·ªánh `/summary` tr·ªè v√†o c√πng handler (ho·∫∑c handler ri√™ng).

## 4. Dev Notes
* **SQL Optimization:** S·ª≠ d·ª•ng `GROUP BY` ƒë·ªÉ t√≠nh to√°n ngay trong DB, tr√°nh loop trong Python.
    ```sql
    SELECT d.name, SUM(CASE WHEN t.type='DEBT' THEN t.amount ELSE -t.amount END) as balance
    FROM transactions t JOIN debtors d ON t.debtor_id = d.id
    WHERE d.user_id = :uid
    GROUP BY d.name
    HAVING balance != 0
    ```