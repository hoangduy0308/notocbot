# Story 4.1: Data Model Upgrade & Identity Mapping

**Status:** Approved
**Epic:** Group Debt & Mutual Notifications
**Priority:** High
**Estimates:** 2 hours

## 1. User Story
**As a** System Admin,
**I want to** cập nhật cấu trúc cơ sở dữ liệu để liên kết `telegram_id` với hồ sơ người nợ (Debtor),
**So that** hệ thống có thể định danh chính xác người dùng trong các nhóm chat và hỗ trợ các tính năng thông báo tương tác sau này.

## 2. Acceptance Criteria
* **AC1:** Bảng `debtors` trong PostgreSQL có thêm cột `telegram_id`.
    * Type: `BigInteger`
    * Constraint: `Nullable` (để tương thích dữ liệu cũ), `Unique` (trong phạm vi ngữ cảnh hợp lý, nhưng bắt buộc phải Index).
* **AC2:** SQLAlchemy Model `Debtor` trong `src/database/models.py` được cập nhật field mới.
* **AC3:** Script migration (Alembic) được tạo ra và chạy thành công (`upgrade head`) mà không gây lỗi hay mất dữ liệu hiện có.
* **AC4:** Dữ liệu cũ (chưa có telegram_id) vẫn truy xuất bình thường.

## 3. Tasks
- [ ] **Task 1: Update SQLAlchemy Model**
    - File: `src/database/models.py`
    - Action: Thêm `telegram_id = Column(BigInteger, nullable=True, index=True)` vào class `Debtor`.
- [ ] **Task 2: Generate Migration Script**
    - Tool: Alembic
    - Command: `alembic revision --autogenerate -m "add telegram_id to debtors"`
    - Verify: Kiểm tra file migration sinh ra trong `migrations/versions/`.
- [ ] **Task 3: Apply Migration**
    - Command: `alembic upgrade head`
    - Validation: Check cấu trúc bảng trong DB sau khi chạy.

## 4. Dev Notes (Context for AI Agent)
* **Current Architecture:**
    * Project sử dụng `SQLAlchemy` (Async) và `Alembic` để quản lý DB.
    * File Model hiện tại nằm ở `src/database/models.py`.
* **Constraints:**
    * Tuyệt đối không được Drop Table `debtors` vì đây là dự án Brownfield đang có dữ liệu thật.
    * Cột mới bắt buộc phải `nullable=True` vì dữ liệu cũ chưa có thông tin này.
* **Integration:**
    * Việc này là tiền đề cho tính năng Tagging trong Group Chat (Story 4.2).